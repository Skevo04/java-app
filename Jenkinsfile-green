pipeline {
    agent any
    
    environment {
        DOCKER_IMAGE = 'petclinic'
        DOCKER_TAG = "${BUILD_NUMBER}"
        WORKSPACE_PATH = "${env.WORKSPACE}"

        DOCKER_REGISTRY = 'ghcr.io'
        GITHUB_USERNAME = 'skevo04'
        GITHUB_REPO = 'java-app'
        GHCR_CREDENTIALS_ID = 'github_token'

        BLUE_SERVER_IP = '192.168.64.9'
        GREEN_SERVER_IP = '192.168.64.6'
        LOADBALANCER_SERVER = '192.168.64.8'
        SERVER_USER = 'ubuntu'
        SSH_CREDENTIALS_ID = 'prod_deploy'
        SSH_CREDENTIALS_ID_LOADBALANCER = 'jenkins_loadbalancer'
        
        // Health check configuration
        HEALTH_CHECK_MAX_RETRIES = '10'
        HEALTH_CHECK_RETRY_DELAY = '10' // seconds
        
        // Rollback configuration
        PREVIOUS_DOCKER_TAG = "${env.BUILD_NUMBER.toInteger() - 1}"
    }
    
    stages {
        // STAGE 1: Build
        stage('Build') {
            parallel {
                stage('Frontend build') {
                    steps {
                        sh '''
                        set -e
                        chmod +x ./mvnw || true
                        ./mvnw -B -Pcss -DskipTests generate-resources
                        mkdir -p frontend-dist
                        if [ -d target/classes/static ]; then
                          cp -R target/classes/static/* frontend-dist/ || true
                        elif [ -d src/main/resources/static ]; then
                          cp -R src/main/resources/static/* frontend-dist/ || true
                        fi
                        '''
                    }
                    post {
                        always {
                            archiveArtifacts artifacts: 'frontend-dist/**', allowEmptyArchive: true
                        }
                    }
                }

                stage('Backend build') {
                    steps {
                        sh '''
                        set -e
                        chmod +x ./mvnw || true
                        ./mvnw -B -DskipTests clean package
                        '''
                    }
                    post {
                        success {
                            archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                        }
                    }
                }
            }
        }
        
        stage('Docker Build') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                    docker.build("${DOCKER_IMAGE}:latest")
                }
            }
        }

        // STAGE 2: Deploy to Prod (GREEN)
        stage('Deploy to Prod GREEN') {
            environment {
                GHCR_TOKEN = credentials("${GHCR_CREDENTIALS_ID}")
            }
            steps {
                script {
                    echo "Deploying to Production GREEN environment"
                    
                    // 1. Login and pull image on Jenkins agent
                    sh """
                        echo \"\${GHCR_TOKEN}\" | docker login ${DOCKER_REGISTRY} -u ${GITHUB_USERNAME} --password-stdin
                        docker pull ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:latest
                    """
                    
                    // 2. Transfer and deploy directly
                    sshagent([SSH_CREDENTIALS_ID]) {
                        sh """
                            # Deploy on production server
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${GREEN_SERVER_IP} '
                                docker stop petclinic || true
                                docker rm petclinic || true
                            '
                            
                            docker save ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:latest | \
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${GREEN_SERVER_IP} docker load
                            
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${GREEN_SERVER_IP} '
                                docker run -d \
                                    --name petclinic \
                                    -p 8080:8080 \
                                    ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:latest
                                
                                sleep 30
                                echo "Container status:"
                                docker ps
                                echo "âœ… GREEN deployment successful!"
                            '
                        """
                    }
                }
            }
            post {
                success {
                    echo "Production GREEN deployment completed successfully"
                }
                failure {
                    echo "Production GREEN deployment failed"
                }
            }
        }
        
        // STAGE 3: Redirect Traffic to GREEN
        stage('Redirect Traffic to GREEN') {
            steps {
                script {
                    echo "Deploying Nginx Load Balancer - Redirecting traffic to GREEN"
                    
                    sshagent([SSH_CREDENTIALS_ID_LOADBALANCER]) {
                        sh """
                            scp -o StrictHostKeyChecking=no /home/jenkins/nginx-loadbalancer-redirectgreen.conf ${SERVER_USER}@${LOADBALANCER_SERVER}:/home/ubuntu/
                            scp -o StrictHostKeyChecking=no /home/jenkins/status-page.html ${SERVER_USER}@${LOADBALANCER_SERVER}:/home/ubuntu/
                            scp -o StrictHostKeyChecking=no /home/jenkins/workspace/final-project-build_main/docker-compose-loadbalancer.yml ${SERVER_USER}@${LOADBALANCER_SERVER}:/home/ubuntu/
                            
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${LOADBALANCER_SERVER} '
                                cd /home/ubuntu
                                docker-compose -f docker-compose-loadbalancer.yml down || true
                                docker-compose -f docker-compose-loadbalancer.yml up -d
                                echo "Load balancer deployed successfully!"
                                echo "ðŸŽ¯ Users should now access: http://${LOADBALANCER_SERVER}"
                                echo "ðŸ“Š Status page: http://${LOADBALANCER_SERVER}/status"
                            '
                        """
                    }
                }
            }
            post {
                success {
                    echo "Load balancer deployed successfully! Traffic redirected to GREEN."
                    echo "Single access point: http://${LOADBALANCER_SERVER}"
                }
                failure {
                    echo "Load balancer deployment failed"
                }
            }
        }
        
        // STAGE 4: Health Check
       stage('Health Check') {
    steps {
        script {
            echo "Performing health check on GREEN deployment..."
            
            def healthCheckPassed = false
            def retries = env.HEALTH_CHECK_MAX_RETRIES.toInteger()
            
            for (int i = 1; i <= retries; i++) {
                try {
                    echo "Health check attempt ${i}/${retries} on GREEN server: ${GREEN_SERVER_IP}"
                    
                    // Use SSH agent to connect to GREEN server
                    sshagent([SSH_CREDENTIALS_ID]) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${GREEN_SERVER_IP} '
                                curl -f http://localhost:8080/actuator/health || \\
                                curl -f http://localhost:8080 || \\
                                exit 1
                            '
                        """
                    }
                    
                    echo "âœ… Health check passed! New deployment is healthy."
                    healthCheckPassed = true
                    break
                    
                } catch (Exception e) {
                    echo "âš ï¸ Health check attempt ${i} failed, waiting ${env.HEALTH_CHECK_RETRY_DELAY} seconds..."
                    if (i < retries) {
                        sleep env.HEALTH_CHECK_RETRY_DELAY.toInteger()
                    }
                }
            }
            
            if (!healthCheckPassed) {
                echo "âŒ All health check attempts failed. Application is not healthy."
                currentBuild.result = 'UNSTABLE'
                env.HEALTH_CHECK_FAILED = 'true'
            } else {
                env.HEALTH_CHECK_FAILED = 'false'
            }
        }
    }
}
        
        // STAGE 5: Conditional Rollback
        stage('Rollback') {
            when {
                expression { env.HEALTH_CHECK_FAILED == 'true' }
            }
            environment {
                GHCR_TOKEN = credentials("${GHCR_CREDENTIALS_ID}")
            }
            steps {
                script {
                    echo "ðŸš¨ HEALTH CHECK FAILED - Initiating rollback to previous version"
                    
                    sshagent([SSH_CREDENTIALS_ID]) {
                        sh """
                            # Rollback on GREEN server
                            ssh -o StrictHostKeyChecking=no ${SERVER_USER}@${GREEN_SERVER_IP} '
                                echo "Stopping current deployment..."
                                docker stop petclinic || true
                                docker rm petclinic || true
                                
                                echo "Attempting to rollback to previous version: ${PREVIOUS_DOCKER_TAG}"
                                # Try to use the previous tag, if not available use latest as fallback
                                if docker pull ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:${PREVIOUS_DOCKER_TAG}; then
                                    echo "Rolling back to tag: ${PREVIOUS_DOCKER_TAG}"
                                    docker run -d \\
                                        --name petclinic \\
                                        -p 8080:8080 \\
                                        ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:${PREVIOUS_DOCKER_TAG}
                                    echo "âœ… Rollback to previous version completed!"
                                else
                                    echo "Previous tag not found, falling back to latest"
                                    docker pull ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:latest
                                    docker run -d \\
                                        --name petclinic \\
                                        -p 8080:8080 \\
                                        ${DOCKER_REGISTRY}/${GITHUB_USERNAME}/${GITHUB_REPO}:latest
                                    echo "âœ… Rollback to latest version completed!"
                                fi
                                
                                sleep 30
                                echo "Rollback container status:"
                                docker ps
                                echo "Verifying rollback health check..."
                                curl -f http://localhost:8080/actuator/health || curl -f http://localhost:8080 || echo "âš ï¸ Rollback health check also failed"
                            '
                        """
                    }
                }
            }
            post {
                success {
                    echo "ðŸ”„ Rollback procedure completed successfully"
                    // Send rollback notification
                    // emailext body: "Rollback was triggered for build ${BUILD_NUMBER} due to health check failure", subject: "Rollback Alert", to: "team@example.com"
                }
                failure {
                    echo "âŒ Rollback procedure failed"
                }
            }
        }
    }
    
    post {
        always {
            echo "Pipeline execution completed - Build ${currentBuild.result}"
            // Cleanup tasks can go here
        }
        success {
            echo "âœ… Pipeline executed successfully!"
            script {
                if (env.HEALTH_CHECK_FAILED == 'true') {
                    echo "âš ï¸ Pipeline succeeded with rollback (health check failed but rollback was successful)"
                } else {
                    echo "ðŸŽ‰ Pipeline succeeded - new deployment is healthy!"
                }
            }
        }
        unstable {
            echo "âš ï¸ Pipeline marked as unstable - health check failed"
            // emailext body: "Build ${BUILD_NUMBER} failed health check and was rolled back", subject: "Health Check Failure & Rollback", to: "team@example.com"
        }
        failure {
            echo "âŒ Pipeline failed!"
            // emailext body: "Build ${BUILD_NUMBER} failed during deployment", subject: "Deployment Failure", to: "team@example.com"
        }
    }
}